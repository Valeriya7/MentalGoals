<ion-header class="ion-no-border">
  <ion-toolbar mode="md" color="primary">
    <ion-title>{{ 'CHALLENGES.AVAILABLE_CHALLENGES' | translate }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="deactivateAllChallenges()" color="light">пара
        <ion-icon name="close-circle-outline" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button (click)="goToNotifications()" [attr.aria-label]="'COMMON.NOTIFICATIONS' | translate">
        <ion-icon name="notifications-outline" class="icon-only"></ion-icon>
      </ion-button>
      <ion-button (click)="goToBookmarks()" [attr.aria-label]="'COMMON.BOOKMARKS' | translate">
        <ion-icon name="bookmark-outline" class="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <div class="challenges-list">
    <div class="challenge-card" *ngFor="let challenge of challenges" role="article">
      <h2>{{ challenge.title }}</h2>
      <p>{{ challenge.description }}</p>
      
      <span class="status" [ngClass]="challenge.status" role="status">
        {{ 'CHALLENGES.STATUS_' + challenge.status.toUpperCase() | translate }}
      </span>
      
      <div class="challenge-info">
        <div class="info-item" role="complementary">
          <ion-icon name="calendar-outline" class="icon-only" [attr.aria-label]="'DAYS' | translate"></ion-icon>
          <span>{{ challenge.duration }} {{ 'DAYS' | translate }}</span>
        </div>
        <div class="info-item" *ngIf="challenge.status === 'active'" role="complementary">
          <ion-icon name="time-outline" class="icon-only" [attr.aria-label]="'CHALLENGES.DAY' | translate"></ion-icon>
          <span>{{ 'CHALLENGES.DAY' | translate }} {{ challenge.currentDay }} {{ 'CHALLENGES.OF' | translate }} {{ challenge.duration }}</span>
        </div>
      </div>

      <div class="tasks" *ngIf="challenge.status === 'active' && challenge.tasks" role="region" [attr.aria-label]="'CHALLENGES.DAILY_TASKS' | translate">
        <h3>{{ 'CHALLENGES.DAILY_TASKS' | translate }}</h3>
        
        <!-- Debug output 
        <div style="background: #f0f0f0; padding: 10px; margin: 10px 0;">
          <p>Challenge status: {{ challenge.status }}</p>
          <p>Tasks count: {{ challenge.tasks ? challenge.tasks.length : 0 }}</p>
          <pre>{{ challenge.tasks | json }}</pre>
        </div>
  -->
        <ion-list *ngIf="challenge.tasks.length > 0">
          <ion-item *ngFor="let task of challenge.tasks; let i = index" role="listitem">
            <ion-icon [name]="task.icon" slot="start" class="icon-only" [attr.aria-label]="task.title"></ion-icon>
            <ion-label>
              <h3>{{ i + 1 }}. {{ task.title }}</h3>
              <p>{{ task.description }}</p>
            </ion-label>
            <ion-badge slot="end" [color]="task.completed ? 'success' : 'medium'" role="status">
              {{ task.completed ? ('CHALLENGES.COMPLETED' | translate) : ('CHALLENGES.NOT_COMPLETED' | translate) }}
            </ion-badge>
          </ion-item>
        </ion-list>
        
        <div *ngIf="!challenge.tasks.length" class="ion-text-center ion-padding">
          <p>{{ 'CHALLENGES.NO_TASKS' | translate }}</p>
        </div>

        <div class="rewards" *ngIf="challenge.rewards" role="region" [attr.aria-label]="'CHALLENGES.REWARDS' | translate">
          <h3>Rewards: {{ 'CHALLENGES.REWARDS' | translate }}</h3>
          <ion-list>
            <ion-item role="listitem">
              <ion-icon name="trophy-outline" slot="start" class="icon-only" [attr.aria-hidden]="true"></ion-icon>
              <ion-label>
                <h3>{{ challenge.rewards.points }} {{ 'CHALLENGES.POINTS' | translate }}</h3>
                <p>{{ 'CHALLENGES.FOR_COMPLETION' | translate }}</p>
              </ion-label>
            </ion-item>
            
            <ion-item-divider>
              <ion-label>
                <h3>{{ 'CHALLENGES.PARTNER_DISCOUNTS' | translate }}</h3>
              </ion-label>
            </ion-item-divider>

            <ion-item *ngFor="let discount of challenge.rewards.discounts" role="listitem" lines="none" class="discount-item">
              <ion-icon [name]="getPartnerIcon(discount.brand)" slot="start" class="icon-only" [attr.aria-hidden]="true"></ion-icon>
              <ion-label>
                <h3>{{ discount.brand }}</h3>
                <p>{{ 'CHALLENGES.DISCOUNT_OF' | translate: { amount: discount.amount } }}</p>
              </ion-label>
              <ion-chip [color]="getDiscountColor(discount.amount)" slot="end">
                <ion-label>{{ discount.amount }}</ion-label>
              </ion-chip>
            </ion-item>

            <ion-item lines="none" class="discount-note">
              <ion-icon name="information-circle-outline" slot="start" class="icon-only" inert></ion-icon>
              <ion-label class="ion-text-wrap">
                <p>{{ 'CHALLENGES.DISCOUNT_NOTE' | translate }}</p>
              </ion-label>
            </ion-item>
          </ion-list>
        </div>
      </div>

      <ion-button expand="block" 
                  class="btn-challenge"
                  (click)="activateChallenge(challenge)" 
                  *ngIf="!challenge.status || challenge.status === 'completed'"
                  [attr.aria-label]="'CHALLENGES.ACTIVATE' | translate">
        {{ 'CHALLENGES.ACTIVATE' | translate }}
      </ion-button>
      <ion-button expand="block" 
                  (click)="goToChallenge(challenge)" 
                  *ngIf="challenge.status === 'active'"
                  color="success"
                  class="btn-challenge"
                  [attr.aria-label]="'CHALLENGES.VIEW_DETAILS' | translate">
        {{ 'CHALLENGES.VIEW_DETAILS' | translate }}
      </ion-button>
    </div>
  </div>
</ion-content>

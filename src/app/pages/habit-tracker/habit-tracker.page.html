<ion-header class="ion-no-border">
  <ion-toolbar mode="md" color="primary">
    <ion-title>
       <ion-label class="inbox-name">{{ 'HABITS.TITLE' | translate }}</ion-label>
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <div class="calendar-section">
    <h2>{{ selectedDate | date:'MMMM yyyy' }}</h2>
    <div class="calendar-grid">
      <div class="calendar-header">
        <div>{{ 'HABITS.MON' | translate }}</div>
        <div>{{ 'HABITS.TUE' | translate }}</div>
        <div>{{ 'HABITS.WED' | translate }}</div>
        <div>{{ 'HABITS.THU' | translate }}</div>
        <div>{{ 'HABITS.FRI' | translate }}</div>
        <div>{{ 'HABITS.SAT' | translate }}</div>
        <div>{{ 'HABITS.SUN' | translate }}</div>
      </div>
      <div class="calendar-days">
        <div *ngFor="let date of currentMonth"
             class="calendar-day"
             [class.today]="isToday(date)"
             [class.has-activity]="hasActivity(date)"
             [class.other-month]="date.getMonth() !== selectedDate.getMonth()"
             (click)="selectDay(date)">
          {{ date.getDate() }}
        </div>
      </div>
    </div>
  </div>

  <div class="habits-section">
    <h2>{{ 'HABITS.ACTIVE_HABITS' | translate }}</h2>
    <ion-list>
      <ion-item-sliding *ngFor="let habit of activeHabits">
        <ion-item class="habit-item"
                 [attr.data-habit-id]="habit.id"
                 draggable="true"
                 (dragstart)="onDragStart($event, habit)"
                 (dragend)="onDragEnd($event)"
                 (dragover)="onDragOver($event)"
                 (drop)="onDrop($event, 'active', habit)"
                 [class.dragging]="draggedHabit === habit"
                 [class.drag-over]="draggedHabit && draggedHabit !== habit"
                 [attr.passive]="true">
          <ion-icon [name]="getHabitIcon(habit.category)" slot="start" [color]="getHabitColor(habit.category)"></ion-icon>
          <ion-label>
            <h2>{{ habit.name }}</h2>
            <p>{{ 'HABITS.CURRENT_STREAK' | translate }}: {{ habit.streak.current }} {{ 'HABITS.DAYS' | translate }}</p>
            <p>{{ 'HABITS.BEST_STREAK' | translate }}: {{ habit.streak.best }} {{ 'HABITS.DAYS' | translate }}</p>
          </ion-label>
          <div class="habit-progress">
            <div class="progress-bar">
              <div class="progress"
                   [style.width.%]="(habit.streak.current / habit.target) * 100">
              </div>
            </div>
            <span class="progress-text">{{ habit.streak.current }}/{{ habit.target }}</span>
          </div>
          <ion-button slot="end" 
                    (click)="toggleHabitCompletion(habit, selectedDate, getHabitStatus(habit, selectedDate) === 'completed' ? 'not_completed' : 'completed')"
                    [class.completed]="getHabitStatus(habit, selectedDate) === 'completed'">
            <ion-icon [name]="getHabitStatus(habit, selectedDate) === 'completed' ? 'checkmark-circle-outline' : 'time-outline'"></ion-icon>
          </ion-button>
          <ion-button slot="end" (click)="deactivateHabit(habit)" color="warning" >
            <ion-icon name="checkmark-circle-outline"></ion-icon>
          </ion-button>
        </ion-item>
        <ion-item-options side="end" class="button-options">
          <ion-item-option color="primary" (click)="openEditHabitModal(habit)" *ngIf="!habit.isBaseHabit">
            <ion-icon name="pencil-outline" slot="icon-only"></ion-icon>
          </ion-item-option>
          <ion-item-option color="danger" (click)="deleteHabit(habit)" *ngIf="!habit.isBaseHabit">
            <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
          </ion-item-option>
        </ion-item-options>
      </ion-item-sliding>
    </ion-list>
  </div>

  <div class="habits-section">
    <h2>{{ 'HABITS.AVAILABLE_HABITS' | translate }}</h2>
    <ion-list>
      <ion-item-sliding *ngFor="let habit of availableHabits">
        <ion-item class="habit-item"
                 draggable="true"
                 (dragstart)="onDragStart($event, habit)"
                 (dragend)="onDragEnd($event)"
                 (dragover)="onDragOver($event)"
                 (drop)="onDrop($event, 'available', habit)"
                 [class.dragging]="draggedHabit === habit"
                 [class.drag-over]="draggedHabit && draggedHabit !== habit"
                 [attr.passive]="true">
          <ion-icon [name]="getHabitIcon(habit.category)" slot="start" [color]="getHabitColor(habit.category)"></ion-icon>
          <ion-label>
            <h2>{{ habit.name }}</h2>
            <p>{{ habit.description }}</p>
            <p>{{ 'HABITS.DIFFICULTY' | translate }}: {{ 'HABITS.DIFFICULTY_' + habit.difficulty.toUpperCase() | translate }}</p>
            <p>{{ 'HABITS.POINTS' | translate }}: {{ habit.points }}</p>
          </ion-label>
          <ion-button slot="end" (click)="activateHabit(habit)">
            <ion-icon name="add-circle-outline"></ion-icon>
          </ion-button>
        </ion-item>
        <ion-item-options side="end">
          <ion-item-option color="primary" (click)="openEditHabitModal(habit)" *ngIf="!habit.isBaseHabit">
            <ion-icon name="pencil-outline" slot="icon-only"></ion-icon>
          </ion-item-option>
          <ion-item-option color="danger" (click)="deleteHabit(habit)" *ngIf="!habit.isBaseHabit">
            <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
          </ion-item-option>
        </ion-item-options>
      </ion-item-sliding>
    </ion-list>
  </div>

  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button (click)="openCreateHabitModal()">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <!-- Модальне вікно для створення звички -->
  <ion-modal [isOpen]="isCreateHabitModalOpen" (didDismiss)="closeCreateHabitModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>{{ 'HABITS.CREATE_HABIT' | translate }}</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeCreateHabitModal()">
              <ion-icon slot="icon-only" name="close-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <form (ngSubmit)="createHabit()" #habitForm="ngForm">
          <ion-input placeholder="name" label="{{ 'HABITS.NAME' | translate }}" [(ngModel)]="newHabit.name" type="name" name="name"></ion-input>
          <ion-input placeholder="description" label="{{ 'HABITS.DESCRIPTION' | translate }}" [(ngModel)]="newHabit.description" type="name" name="description" required></ion-input>

          <ion-select
            label="{{ 'HABITS.CATEGORY' | translate }}"
            [(ngModel)]="newHabit.category"
            name="category">
            <ion-select-option value="health">{{ 'HABITS.CATEGORIES.HEALTH' | translate }}</ion-select-option>
            <ion-select-option value="fitness">{{ 'HABITS.CATEGORIES.FITNESS' | translate }}</ion-select-option>
            <ion-select-option value="mindfulness">{{ 'HABITS.CATEGORIES.MINDFULNESS' | translate }}</ion-select-option>
            <ion-select-option value="nutrition">{{ 'HABITS.CATEGORIES.NUTRITION' | translate }}</ion-select-option>
            <ion-select-option value="learning">{{ 'HABITS.CATEGORIES.LEARNING' | translate }}</ion-select-option>
            <ion-select-option value="productivity">{{ 'HABITS.CATEGORIES.PRODUCTIVITY' | translate }}</ion-select-option>
          </ion-select>

          <ion-select
            label="{{ 'HABITS.DIFFICULTY' | translate }}"
            [(ngModel)]="newHabit.difficulty"
            name="difficulty">
            <ion-select-option value="easy">{{ 'HABITS.DIFFICULTY_EASY' | translate }}</ion-select-option>
            <ion-select-option value="medium">{{ 'HABITS.DIFFICULTY_MEDIUM' | translate }}</ion-select-option>
            <ion-select-option value="hard">{{ 'HABITS.DIFFICULTY_HARD' | translate }}</ion-select-option>
          </ion-select>

          <ion-input placeholder="points" label="{{ 'HABITS.POINTS' | translate }}" [(ngModel)]="newHabit.points" type="number" name="points"></ion-input>
          <ion-input placeholder="target" label="{{ 'HABITS.TARGET' | translate }}" [(ngModel)]="newHabit.target" type="number" name="target"></ion-input>
          <ion-input placeholder="unit" label="{{ 'HABITS.UNIT' | translate }}" [(ngModel)]="newHabit.unit" type="name" name="unit"></ion-input>

          <ion-select
            label="{{ 'HABITS.FREQUENCY' | translate }}"
            [(ngModel)]="newHabit.frequency"
            name="frequency">
            <ion-select-option value="daily">{{ 'HABITS.FREQUENCY_DAILY' | translate }}</ion-select-option>
            <ion-select-option value="weekly">{{ 'HABITS.FREQUENCY_WEEKLY' | translate }}</ion-select-option>
            <ion-select-option value="monthly">{{ 'HABITS.FREQUENCY_MONTHLY' | translate }}</ion-select-option>
          </ion-select>

          <div class="ion-padding">
            <ion-button expand="block" type="submit">
              {{ 'HABITS.CREATE' | translate }}
            </ion-button>
          </div>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>

  <!-- Модальне вікно для редагування звички -->
  <ion-modal [isOpen]="isEditHabitModalOpen" (didDismiss)="closeEditHabitModal()">
    <ion-header>
      <ion-toolbar>
        <ion-title>{{ 'HABITS.EDIT_HABIT' | translate }}</ion-title>
        <ion-buttons slot="end">
          <ion-button fill="clear" (click)="closeEditHabitModal()">
            <ion-icon slot="icon-only" name="close" style="font-size: 24px;"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <form (ngSubmit)="updateHabit()" #habitForm="ngForm" *ngIf="editingHabit">
        <ion-item>
          <ion-input
            [(ngModel)]="editingHabit.name"
            name="name"
            required
            label="{{ 'HABITS.NAME' | translate }}"
            aria-label="{{ 'HABITS.NAME' | translate }}">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-textarea
            [(ngModel)]="editingHabit.description"
            name="description"
            required
            label="{{ 'HABITS.DESCRIPTION' | translate }}"
            aria-label="{{ 'HABITS.DESCRIPTION' | translate }}">
          </ion-textarea>
        </ion-item>

        <ion-item>
          <ion-select
            [(ngModel)]="editingHabit.category"
            name="category"
            required
            label="{{ 'HABITS.CATEGORY' | translate }}"
            aria-label="{{ 'HABITS.CATEGORY' | translate }}">
            <ion-select-option value="health">{{ 'HABITS.CATEGORIES.HEALTH' | translate }}</ion-select-option>
            <ion-select-option value="fitness">{{ 'HABITS.CATEGORIES.FITNESS' | translate }}</ion-select-option>
            <ion-select-option value="mindfulness">{{ 'HABITS.CATEGORIES.MINDFULNESS' | translate }}</ion-select-option>
            <ion-select-option value="nutrition">{{ 'HABITS.CATEGORIES.NUTRITION' | translate }}</ion-select-option>
            <ion-select-option value="learning">{{ 'HABITS.CATEGORIES.LEARNING' | translate }}</ion-select-option>
            <ion-select-option value="productivity">{{ 'HABITS.CATEGORIES.PRODUCTIVITY' | translate }}</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-select
            [(ngModel)]="editingHabit.difficulty"
            name="difficulty"
            required
            label="{{ 'HABITS.DIFFICULTY' | translate }}"
            aria-label="{{ 'HABITS.DIFFICULTY' | translate }}">
            <ion-select-option value="easy">{{ 'HABITS.DIFFICULTY_EASY' | translate }}</ion-select-option>
            <ion-select-option value="medium">{{ 'HABITS.DIFFICULTY_MEDIUM' | translate }}</ion-select-option>
            <ion-select-option value="hard">{{ 'HABITS.DIFFICULTY_HARD' | translate }}</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-input
            type="number"
            [(ngModel)]="editingHabit.points"
            name="points"
            required
            label="{{ 'HABITS.POINTS' | translate }}"
            aria-label="{{ 'HABITS.POINTS' | translate }}">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-input
            type="number"
            [(ngModel)]="editingHabit.target"
            name="target"
            required
            label="{{ 'HABITS.TARGET' | translate }}"
            aria-label="{{ 'HABITS.TARGET' | translate }}">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-input
            [(ngModel)]="editingHabit.unit"
            name="unit"
            label="{{ 'HABITS.UNIT' | translate }}"
            aria-label="{{ 'HABITS.UNIT' | translate }}">
          </ion-input>
        </ion-item>

        <ion-item>
          <ion-select
            [(ngModel)]="editingHabit.frequency"
            name="frequency"
            required
            label="{{ 'HABITS.FREQUENCY' | translate }}"
            aria-label="{{ 'HABITS.FREQUENCY' | translate }}">
            <ion-select-option value="daily">{{ 'HABITS.FREQUENCY_DAILY' | translate }}</ion-select-option>
            <ion-select-option value="weekly">{{ 'HABITS.FREQUENCY_WEEKLY' | translate }}</ion-select-option>
            <ion-select-option value="monthly">{{ 'HABITS.FREQUENCY_MONTHLY' | translate }}</ion-select-option>
          </ion-select>
        </ion-item>

        <div class="ion-padding">
          <ion-button expand="block" type="submit">
            {{ 'UPDATE' | translate }}
          </ion-button>
        </div>
      </form>
    </ion-content>
  </ion-modal>
</ion-content>

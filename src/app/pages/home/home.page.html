<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-avatar (click)="goToProfile()">
        <img *ngIf="userPhotoUrl" [src]="userPhotoUrl"  />
        <img *ngIf="!userPhotoUrl" src="../../../assets/images/avatar/4.jpg" />

        <!--
        <img *ngIf="userPhotoUrl" [src]="userPhotoUrl" alt="User avatar" (error)="handleAvatarError($event)">
        <ion-icon *ngIf="!userPhotoUrl" name="person-circle-outline" class="avatar-icon"></ion-icon>
        -->
      </ion-avatar>
      <div class="user-info">
        <h2>{{ 'COMMON.WELCOME' | translate }}</h2>
        <h3>{{ userName }}</h3>
      </div>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-button (click)="goToNotifications()" class="notification-button">
        <ion-icon name="notifications-outline" slot="icon-only"></ion-icon>
        <ion-badge *ngIf="hasNotification('notifications')" color="danger" class="notification-badge">!</ion-badge>
      </ion-button>
      <ion-button (click)="openEmotionalStateModal()" class="notification-button">
        <ion-icon name="happy-outline" slot="icon-only"></ion-icon>
        <ion-badge *ngIf="hasNotification('emotionalState')" color="danger" class="notification-badge">!</ion-badge>
      </ion-button>
      <ion-button (click)="openDailyWish()" class="notification-button">
        <ion-icon name="cafe-outline" slot="icon-only"></ion-icon>
        <ion-badge *ngIf="hasNotification('dailyWish')" color="danger" class="notification-badge">!</ion-badge>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">

  <!-- Побажання -->
  <ion-card class="wish-card" (click)="showWish()" *ngIf="currentWish">
    <ion-card-content>
      <ion-icon name="heart-outline" [class.unread]="hasUnreadWish"></ion-icon>
      <p>{{ currentWish }}</p>
    </ion-card-content>
  </ion-card>

  <!-- Графік досягнень -->
  <ion-card class="achievement-chart-card">
    <ion-card-header>
      <ion-segment [(ngModel)]="selectedPeriod" (ionChange)="onPeriodChange($event)">
        <ion-segment-button value="week">
          <ion-label>{{ 'HOME.PERIOD.WEEK' | translate }}</ion-label>
        </ion-segment-button>
        <ion-segment-button value="month">
          <ion-label>{{ 'HOME.PERIOD.MONTH' | translate }}</ion-label>
        </ion-segment-button>
        <ion-segment-button value="year">
          <ion-label>{{ 'HOME.PERIOD.YEAR' | translate }}</ion-label>
        </ion-segment-button>
      </ion-segment>
    </ion-card-header>
    <ion-card-content>
      <div class="chart-container">
        <canvas #achievementChart></canvas>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- Active Challenges Progress -->
  <div *ngIf="activeChallenges.length > 0" class="active-challenges">
    <div class="challenges-grid">
      <div *ngFor="let challenge of activeChallenges" class="challenge-card">
        <div class="challenge-progress">
          <div class="circular-progress">
            <svg class="progress-ring" width="90" height="90">
              <circle
                class="progress-ring__circle-bg"
                cx="40"
                cy="40"
                r="34"
                fill="none"
                stroke="var(--ion-color-light)"
                stroke-width="8"
              />
              <circle
                class="progress-ring__circle"
                cx="40"
                cy="40"
                r="34"
                fill="none"
                stroke="var(--ion-color-primary)"
                stroke-width="8"
                [style.stroke-dasharray]="getProgressCircumference(challenge)"
                [style.stroke-dashoffset]="getProgressOffset(challenge)"
              />
            </svg>
            <div class="progress-text">
              <span class="percentage">{{ getProgressPercentage(challenge) }}%</span>
              <span class="days">{{ getCurrentDay(challenge) }}/{{ challenge.duration }}</span>
            </div>
          </div>
          <h3 class="challenge-title">{{ challenge.title }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- All Active Tasks -->
  <div *ngIf="allDailyTasks.length > 0" class="all-tasks">
    <h2>Всі активні завдання</h2>
    <ion-list>
      <ion-item *ngFor="let task of allDailyTasks" [class.completed]="task.completed">
        <ion-checkbox
          slot="start"
          [checked]="task.completed"
          (ionChange)="updateTaskProgress(task, $event)"
          aria-label="{{ task.title }}"></ion-checkbox>
        <div class="task-content">
          <h2>{{ task.title }}</h2>
          <p>{{ task.description }}</p>
          <span class="challenge-title">{{ task.challengeTitle }}</span>
        </div>
        <ion-icon [name]="task.icon" slot="end"></ion-icon>
      </ion-item>
    </ion-list>
  </div>

  <!-- No Active Challenge -->
  <div *ngIf="!activeChallenges.length && allDailyTasks.length === 0" class="no-challenge">
    <ion-card>
      <ion-card-header>
        <ion-card-title>{{ 'HOME.NO_ACTIVE_CHALLENGE' | translate }}</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <p>{{ 'HOME.CHOOSE_CHALLENGE' | translate }}</p>
        <ion-button expand="block" (click)="goToChallenges()">
          {{ 'HOME.GO_TO_CHALLENGES' | translate }}
        </ion-button>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Статистика -->
  <div class="stats-grid">
    <div class="stat-item" (click)="goToHabit('steps')">
      <ion-icon name="footsteps-outline"></ion-icon>
      <h3>{{ 'HOME.STEPS' | translate }}</h3>
      <h2>{{ stepsCount }}</h2>
      <div class="stats-item">
        <div class="metric-header">
          <img src="assets/icons/empty-set.svg" class="primary" alt="{{ 'EMPTY_SET' | translate }}" />
          <span class="metric-value">{{ averageSteps | number:'1.0-0' }}</span>
        </div>
      </div>
    </div>
    <div class="stat-item" (click)="goToHabit('sleep')">
      <ion-icon name="moon-outline"></ion-icon>
      <h3>{{ 'HOME.SLEEP' | translate }}</h3>
      <h2>{{ sleepHours }}</h2>
      <div class="stats-item">
        <div class="metric-header">
          <img src="assets/icons/empty-set.svg" class="primary" alt="{{ 'EMPTY_SET' | translate }}" />
          <span class="metric-value">{{ averageSleep | number:'1.1-1' }} Hr</span>
        </div>
      </div>
    </div>
    <div class="stat-item" (click)="goToHabit('water')">
      <ion-icon name="water-outline"></ion-icon>
      <h3>{{ 'HOME.WATER' | translate }}</h3>
      <h2>{{ waterAmount }}</h2>
      <div class="stats-item">
        <div class="metric-header">
          <img src="assets/icons/empty-set.svg" class="primary" alt="{{ 'EMPTY_SET' | translate }}" />
          <span class="metric-value">{{ averageWater | number:'1.0-1' }} L</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Швидкі дії -->
  <ion-grid>
    <ion-row>
      <ion-col size="6">
        <ion-button expand="block" (click)="goToLifeWheel()" [attr.aria-label]="'Перейти до колеса життя'">
          <ion-icon name="settings-outline" slot="start" [attr.aria-hidden]="true"></ion-icon>
          {{ 'HOME.LIFE_WHEEL' | translate }}
        </ion-button>
      </ion-col>
      <!--
      <ion-col size="6">
        <ion-button expand="block" (click)="goToEmotionalCalendar()" [attr.aria-label]="'Перейти до поточного челенджу'">
          <ion-icon name="calendar-outline" slot="start" [attr.aria-hidden]="true"></ion-icon>
          {{ 'HOME.CHALLENGE' | translate }}
        </ion-button>
      </ion-col>
      -->
    </ion-row>
  </ion-grid>

</ion-content>
